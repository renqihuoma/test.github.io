<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>跳转中</title>
</head>
<body>
    <div id="status">正在获取跳转地址...</div>

    <script>
        // 核心配置
        const API_CONFIG = {
            url: 'https://api.rqhm100.cc/link/kjladj', // 你的API接口地址
            timeout: 8000,                             // 请求超时时间（毫秒）
        };

        let isRequesting = false; // 防止重复请求的标志

        /**
         * 核心函数：发起请求并处理跳转逻辑
         */
        async function fetchAndRedirect() {
            const statusEl = document.getElementById('status');
            if (isRequesting) return;
            isRequesting = true;
            statusEl.textContent = '正在获取跳转地址...';

            try {
                // 1. 从当前URL中获取 's' 参数
                const sParam = new URLSearchParams(window.location.search).get('s');
                if (!sParam) throw new Error('缺少必要的跳转参数');

                // 2. 构造带有 's' 参数的API请求URL
                const apiUrl = new URL(API_CONFIG.url);
                apiUrl.searchParams.append('s', sParam);

                // 3. 配置请求超时
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.timeout);

                // 4. 发起网络请求
                const response = await fetch(apiUrl.toString(), {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'omit',
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`服务器错误，状态码：${response.status}`);

                // 5. 解析JSON并直接访问目标字段
                const resData = await response.json();
                console.log(resData.data.subCodeUrl);

                // 6. 验证并执行跳转
                const targetUrl = resData.data.subCodeUrl;
                if (targetUrl && typeof targetUrl === 'string' && targetUrl.startsWith('http')) {
                    statusEl.textContent = '正在跳转...';
                    setTimeout(() => window.location.href = targetUrl, 300);
                } else {
                    throw new Error('API未返回有效跳转地址');
                }

            } catch (error) {
                // 7. 错误处理
                console.error('跳转失败:', error);
                // 统一的错误提示，因为直接访问可能导致两种不同的错误
                statusEl.textContent = `跳转失败，请稍后重试。`;
            } finally {
                isRequesting = false;
            }
        }

        // 页面加载完成后自动执行跳转逻辑
        window.addEventListener('DOMContentLoaded', fetchAndRedirect);
    </script>
</body>
</html>
